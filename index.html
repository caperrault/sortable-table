<meta charset="utf-8">
<html>
<head>

<title>Table</title>

<link rel="stylesheet"  href="style.css"/>

<script src="http://d3js.org/d3.v3.min.js"></script>

</head>
<body>

<svg class="canvas"></svg>

<script>

var margin = {top: 20, right: 30, bottom: 30, left: 40},
    width = 960 - margin.left - margin.right,
    height = 2000 - margin.top - margin.bottom;

var canvas = d3.select(".canvas")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var headerGrp = canvas.append("g").attr("class", "headerGrp");
var rowsGrp = canvas.append("g").attr("class","rowsGrp");

var fieldHeight = 20;
var fieldWidth = 200;

var previousSort = null;
var format = d3.time.format("%a %b %d %Y");
//var dateFn = function(date) { return format.parse(d.created_at) };

d3.json("Counties_stats_3col.json", function(data) {

refreshTable(null);

function refreshTable(sortOn){

	// create the table header
	var header = headerGrp.selectAll("g")
		.data(d3.keys(data[0]))
	  .enter().append("g")
		.attr("class", "header")
		.attr("transform", function (d, i){
			return "translate(" + i * fieldWidth + ",0)";
		})
		.on("click", function(d){ return refreshTable(d);});

	header.append("rect")
		.attr("width", fieldWidth)
		.attr("height", fieldHeight)
    .style("border", "2px red solid");

	header.append("text")
		.attr("x", fieldWidth / 2)
		.attr("y", fieldHeight / 2)
		.attr("dy", ".35em")
		.text(String);

	// fill the table
	// select rows
	var rows = rowsGrp.selectAll("g.row").data(data,
    function(d){ return d.County; });

	// create rows
	var rowsEnter = rows.enter().append("svg:g")
		.attr("class","row")
		.attr("transform", function (d, i){
			return "translate(0," + (i+1) * (fieldHeight+1) + ")";
		});

	// select cells
	var cells = rows.selectAll("g.cell").data(function(d){ if (typeof d3.values(d) == "number") {
    return d3.format(',')(d3.values(d));}
    else {
      return d3.values(d);
    };
    })
    .style("border", "2px black solid");

	// create cells
	var cellsEnter = cells.enter().append("svg:g")
		.attr("class", "cell")
		.attr("transform", function (d, i){
			return "translate(" + i * fieldWidth + ",0)";
		})
    .style("border", "2px black solid");

	cellsEnter.append("rect")
		.attr("width", fieldWidth)
		.attr("height", fieldHeight)
    .style("border", "2px black solid");

	cellsEnter.append("text")
		.attr("x", fieldWidth / 2)
		.attr("y", fieldHeight / 2)
		.attr("dy", ".35em")
		.text(String);

	//update if not in initialisation
	if(sortOn !== null) {
			// update rows
			if(sortOn != previousSort){
				rows.sort(function(a,b){return sort(a[sortOn], b[sortOn]);});
				previousSort = sortOn;
			}
			else{
				rows.sort(function(a,b){return sort(b[sortOn], a[sortOn]);});
				previousSort = null;
			}
			rows.transition()
				.duration(500)
				.attr("transform", function (d, i){
					return "translate(0," + (i+1) * (fieldHeight+1) + ")";
				});
	}
}

function sort(a,b){
		return a > b ? 1 : a == b ? 0 : -1;
}

});

</script>

</body>
</html>
